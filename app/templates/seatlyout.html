{% extends "base.html" %}

{% block title %} Select Seats {% endblock %}

{% block content %}

<!-- Header Section -->
<div class="py-4" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
    <div class="container">
        <div class="text-center text-white">
            <h2 class="font-weight-bold mb-2">ü™ë Select Your Seats</h2>
            <p class="mb-0">Choose your preferred seating arrangement</p>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="py-5 bg-light">
    <div class="container">
        <form action="{{ url_for('confirm_booking', schedule_id=schedule.schedule_id)}}" method="POST">
            <div class="row">
                <!-- Seat Layout Section -->
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="text-success font-weight-bold mb-0">Bus Seat Layout</h5>
                                <small class="text-muted">Click on seats to select/deselect</small>
                            </div>

                            <!-- Seat Layout -->
                            <div class="seat-layout"
                                style="background: #f8f9fa; padding: 20px; border-radius: 8px; overflow-x: auto;">
                                <!-- Driver Area -->
                                <div class="text-center mb-4">
                                    <div
                                        style="display: inline-block; padding: 10px 20px; background: #28a745; color: white; border-radius: 5px; font-weight: bold; font-size: 12px;">
                                        üöó DRIVER
                                    </div>
                                </div>

                                <!-- Seats Grid -->
                                <div
                                    style="display: grid; grid-template-columns: repeat(6, 50px); gap: 15px; justify-content: center;">
                                    <!-- Row 1 -->
                                    <div class="seat empty" data-seat="1" style="grid-column: 1;"></div>
                                    <div class="seat empty" data-seat="2" style="grid-column: 2;"></div>
                                    <div style="grid-column: 3;"></div>
                                    <div style="grid-column: 4;"></div>
                                    <div class="seat empty" data-seat="5" style="grid-column: 5;"></div>
                                    <div class="seat empty" data-seat="6" style="grid-column: 6;"></div>
                                    <!-- Row 2 -->
                                    <div class="seat empty" data-seat="7"></div>
                                    <div class="seat empty" data-seat="8"></div>
                                    <div style=""></div>
                                    <div style=""></div>
                                    <div class="seat empty" data-seat="9"></div>
                                    <div class="seat empty" data-seat="10"></div>

                                    <!-- Row 3 -->
                                    <div class="seat empty" data-seat="11"></div>
                                    <div class="seat empty" data-seat="12"></div>
                                    <div style=""></div>
                                    <div style=""></div>
                                    <div class="seat empty" data-seat="13"></div>
                                    <div class="seat empty" data-seat="14"></div>

                                    <!-- Row 4 -->
                                    <div class="seat empty" data-seat="15"></div>
                                    <div class="seat empty" data-seat="16"></div>
                                    <div style=""></div>
                                    <div style=""></div>
                                    <div class="seat empty" data-seat="17"></div>
                                    <div class="seat empty" data-seat="18"></div>

                                    <!-- Row 5 -->
                                    <div class="seat empty" data-seat="19"></div>
                                    <div class="seat empty" data-seat="20"></div>
                                    <div style=""></div>
                                    <div style=""></div>
                                    <div class="seat empty" data-seat="21"></div>
                                    <div class="seat empty" data-seat="22"></div>

                                    <!-- Row 6 -->
                                    <div class="seat empty" data-seat="23"></div>
                                    <div class="seat empty" data-seat="24"></div>
                                    <div style=""></div>
                                    <div style=""></div>
                                    <div class="seat empty" data-seat="25"></div>
                                    <div class="seat empty" data-seat="26"></div>

                                    <!-- Row 7 -->
                                    <div class="seat empty" data-seat="27"></div>
                                    <div class="seat empty" data-seat="28"></div>
                                    <div style=""></div>
                                    <div style=""></div>
                                    <div class="seat empty" data-seat="29"></div>
                                    <div class="seat empty" data-seat="30"></div>

                                    <!-- Row 8 -->
                                    <div class="seat empty" data-seat="31"></div>
                                    <div class="seat empty" data-seat="32"></div>
                                    <div class="seat empty" data-seat="33"></div>
                                    <div class="seat empty" data-seat="34"></div>
                                    <div class="seat empty" data-seat="35"></div>
                                    <div class="seat empty" data-seat="36"></div>
                                </div>
                                <!-- Seat  -->
                                <!-----------------------Dynamic seat layout-------------------------------------------------->
                                <div
                                    style="display: grid; grid-template-columns: repeat(6, 50px); gap: 15px; justify-content: center;">

                                    {% for seat in seats %}
                                    {# Basic math to handle the 2-gap-2 layout #}
                                    {# We use the loop index to determine grid placement #}
                                    {% set col_pos = ((loop.index0 % 4) + 1) %}
                                    {% if col_pos > 2 %}
                                    {% set col_pos = col_pos + 2 %} {# This skips columns 3 and 4 #}
                                    {% endif %}

                                    <div class="seat-wrapper" style="grid-column: {{ col_pos }};">
                                        <div class="seat {% if seat.seat_id in booked_seats %}booked{% else %}empty{% endif %} grid-column: {{ col_pos }};"
                                            data-seat="{{ seat.seat_id }}">
                                            {{ seat.seat_number }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                    <!-------------------------------------------------------------------------------------------->
                                </div>
                                <!-- Legend -->
                                <div class="d-flex justify-content-center gap-4 mt-5 flex-wrap">
                                    <div class="d-flex align-items-center">
                                        <div class="seat-legend empty-legend"
                                            style="width: 30px; height: 30px; border: 2px solid #ddd; border-radius: 4px; margin-right: 8px;">
                                        </div>
                                        <small>Available</small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="seat-legend selected-legend"
                                            style="width: 30px; height: 30px; background: #28a745; border-radius: 4px; margin-right: 8px;">
                                        </div>
                                        <small>Selected</small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="seat-legend booked-legend"
                                            style="width: 30px; height: 30px; background: #dc3545; border-radius: 4px; margin-right: 8px;">
                                        </div>
                                        <small>Booked</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Booking Summary Section -->
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                        <div class="card-body p-4">
                            <h5 class="text-success font-weight-bold mb-4">üìã Booking Summary</h5>

                            <!-- Selected Seats Display -->
                            <div class="alert alert-info border-0" role="alert">
                                <h6 class="font-weight-bold mb-2">Selected Seats</h6>
                                <div id="selectedSeatsDisplay" class="text-center"
                                    style="min-height: 30px; padding: 10px; background: white; border-radius: 4px;">
                                    <small class="text-muted">No seats selected</small>
                                </div>
                            </div>

                            <!-- Count Summary -->
                            <div class="row mb-4">
                                <div class="col-6">
                                    <div class="text-center p-3" style="background: #f8f9fa; border-radius: 8px;">
                                        <h4 class="text-success font-weight-bold mb-0" id="seatCount">0</h4>
                                        <small class="text-muted">Seats Selected</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-3" style="background: #f8f9fa; border-radius: 8px;">
                                        <h4 class="text-success font-weight-bold mb-0" id="totalPrice">‚Çπ0</h4>
                                        <small class="text-muted">Total Price</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Price Info -->
                            <div class="alert alert-light border-1" role="alert">
                                <h6 class="font-weight-bold mb-2">üí∞ Price Details</h6>
                                <p class="mb-1"><small>Price per seat: <strong>‚Çπ500</strong></small></p>
                                <p class="mb-0"><small>Bus: <strong>AC Volvo 9900</strong></small></p>
                            </div>

                            <!-- Trip Info -->
                            <div class="alert alert-light border-1" role="alert">
                                <h6 class="font-weight-bold mb-2">üöå Trip Information</h6>
                                <p class="mb-1"><small><strong>From:</strong> Paitha</small></p>
                                <p class="mb-1"><small><strong>To:</strong> Pune</small></p>
                                <p class="mb-1"><small><strong>Date:</strong> 2024-01-20</small></p>
                                <p class="mb-0"><small><strong>Time:</strong> 10:00 PM</small></p>
                            </div>
                            <input type="hidden" name="selected_seats_list" id="input_seats" value="">
                            <!-- Action Buttons -->
                            <button class="btn btn-success btn-block font-weight-bold py-2 mb-2" id="proceedBtn"
                                type="submit">
                                ‚úì Proceed to Payment
                            </button>
                            <button class="btn btn-outline-secondary btn-block font-weight-bold py-2">
                                ‚Üê Back
                            </button>
                        </div>
                    </div>
                </div>
        </form>
    </div>
</div>

<!-- CSS Styles -->
<style>
    .seat {
        width: 50px;
        height: 50px;
        border: 2px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
        transition: all 0.3s ease;
        user-select: none;
    }

    .seat:hover:not(.booked) {
        transform: scale(1.05);
        border-color: #28a745;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }

    .seat.empty {
        color: #999;
    }

    .seat.selected {
        background: #28a745;
        color: white;
        border-color: #28a745;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .seat.booked {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .seat.booked:hover {
        transform: none;
        box-shadow: none;
    }
</style>

<!-- JavaScript for Seat Selection -->
<script>
    const seatPrice = 500;
    const seats = document.querySelectorAll('.seat');
    const selectedSeatsDisplay = document.getElementById('selectedSeatsDisplay');
    const seatCountDisplay = document.getElementById('seatCount');
    const totalPriceDisplay = document.getElementById('totalPrice');
    const proceedBtn = document.getElementById('proceedBtn');
    const selectedSeatsInput = document.getElementById('input_seats');

    let selectedSeats = [];

    seats.forEach(seat => {
        seat.addEventListener('click', function () {
            // Don't allow selecting booked seats
            if (this.classList.contains('booked')) {
                return;
            }

            // Toggle selection
            if (this.classList.contains('selected')) {
                this.classList.remove('selected');
                selectedSeats = selectedSeats.filter(s => s !== this.dataset.seat);
            } else {
                this.classList.add('selected');
                selectedSeats.push(this.dataset.seat);
            }

            updateSummary();
        });
    });

    function updateSummary() {
        // Update seat count
        seatCountDisplay.textContent = selectedSeats.length;

        // Update total price
        const totalPrice = selectedSeats.length * seatPrice;
        totalPriceDisplay.textContent = '‚Çπ' + totalPrice.toLocaleString();

        // Update selected seats display
        if (selectedSeats.length > 0) {
            selectedSeatsDisplay.innerHTML = '<strong>' + selectedSeats.sort().join(', ') + '</strong>';
        } else {
            selectedSeatsDisplay.innerHTML = '<small class="text-muted">No seats selected</small>';
        }

        // Update hidden input value
        selectedSeatsInput.value = selectedSeats.join(',');
        // Enable/disable proceed button
        proceedBtn.disabled = selectedSeats.length === 0;

    }
</script>

{% endblock %}